<!DOCTYPE html>
<html>
<head>
<title>WS Proto Test</title>
<link rel="icon" href="http://wefefw:3000/wefwef">
<style>

html,body {
margin: 0;
padding: 0;
}

video, canvas {
border: solid;
z-index: 0;
}

#trans {
border-color: blue;
}

#rece {
width: 100%;
border-color: red;
}
</style>
</head>
<body>
<p id="message">Connecting...</p>
<canvas id="trans"></canvas>
<canvas id="rece"></canvas>
<button onclick="transmit()">Stream</button>
</body>
<script type="text/javascript">

// const username = prompt("Choose a username!");
const server = new WebSocket("ws://localhost:3000/chat?username=Randall");
const transmitter = document.querySelector("#trans");
transmitter.style.display = "none";
const tctx = transmitter.getContext("2d");
let width = 127, height = 127;
transmitter.width = width;
transmitter.height = height;
const receiver = document.querySelector("#rece");
const rctx = receiver.getContext("2d");
receiver.width = width;
receiver.height = height;
let connected = false;

function transmit() {
if (connected) {
try {
navigator.mediaDevices.getUserMedia({audio: false, video: { width: width, height: height }}).then(stream => {
 const video = document.createElement("video");
 video.srcObject = stream;
 document.body.appendChild(video);

  function drawFrame() {
  tctx.clearRect(0,0,width,height);
  tctx.drawImage(video,0,0,width,height);
  let frame = tctx.getImageData(0,0,width,height).data;
  frame = frame.buffer;
  server.send(frame);
}

 video.play();
setInterval(drawFrame,100);
}).catch((err) => {
message.innerText = "Camera access rejected! " + err;
});
} catch (err) {
message.innerText = "A client error ocurred!: " + err;
}
}
}

server.addEventListener("message",(frame) => {
if (frame.data.size == width*height*4) {
frame.data.arrayBuffer().then(buffer => {
let data = new ImageData(new Uint8ClampedArray(buffer),width,height);
rctx.clearRect(0,0,width,height);
rctx.putImageData(data,0,0);
}).catch(err => document.write("A CLIENT ERROR OCURRED: " + err));
} 
});

server.addEventListener("open",() => {
 message.innerText = "Connected";
 connected = true;
});

server.addEventListener("error",(err) => {
 message.innerText = "TRANSMISSION ERROR: " + err;
});

server.addEventListener("close",(err) => {
 message.innerText = "CONNECTION WAS CLOSED: " + err.code;
});

</script>
</html>
